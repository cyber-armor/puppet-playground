---
# Traefik Ingress Configuration for Puppet Server
# 
# CRITICAL: Puppet Server port 8140 MUST use SSL passthrough
# Why? Puppet agents validate the server certificate directly
# TLS termination at ingress would break agent authentication

#############################################
# IngressRouteTCP for Puppet Server (Port 8140)
# SSL Passthrough Mode
#############################################
---
apiVersion: traefik.io/v1alpha1
kind: IngressRouteTCP
metadata:
  name: puppet-server-agents
  namespace: puppet
  annotations:
    argocd.argoproj.io/sync-wave: "2"  # Create after services
spec:
  entryPoints:
    - websecure  # Traefik HTTPS entrypoint (typically port 443)
  
  routes:
    - match: HostSNI(`{ .Values.additions.domain }`)  # CHANGE THIS to your public domain!
      services:
        - name: puppet-puppet
          port: 8140
  
  tls:
    passthrough: true  # CRITICAL: Do not terminate TLS at ingress!

---
#############################################
# IngressRoute for Puppetboard (Web UI)
# Normal HTTPS with TLS Termination
#############################################
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: puppetboard-web
  namespace: puppet
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  entryPoints:
    - websecure
  
  routes:
    - match: Host(`puppetboard.{ .Values.additions.domain }`)  # CHANGE THIS!
      kind: Rule
      services:
        - name: puppet-puppetboard
          port: 80
      # Optional: Add middleware for basic auth, rate limiting, etc.
      # middlewares:
      #   - name: puppetboard-auth
  
  tls:
    secretName: puppetboard-tls  # From cert-manager

---
#############################################
# IngressRoute for PuppetDB API (Optional)
# For direct PuppetDB queries
#############################################
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: puppetdb-api
  namespace: puppet
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  entryPoints:
    - websecure
  
  routes:
    - match: Host(`puppetdb.yourdomain.internal`)  # CHANGE THIS!
      kind: Rule
      services:
        - name: puppet-puppetdb
          port: 8080
      # Recommended: Add authentication middleware
      # middlewares:
      #   - name: puppetdb-auth
  
  tls:
    secretName: puppetdb-api-tls  # From cert-manager

---
#############################################
# Optional: Basic Auth Middleware for Puppetboard
#############################################
# Uncomment to add basic authentication to Puppetboard
#
# First, create htpasswd secret:
# htpasswd -nb admin your_password | base64
#
# apiVersion: v1
# kind: Secret
# metadata:
#   name: puppetboard-auth-secret
#   namespace: puppet
# type: Opaque
# data:
#   users: YWRtaW46JGFwcjEkSDY1dC85TUUkdEN.... # base64 encoded htpasswd
#
# ---
# apiVersion: traefik.io/v1alpha1
# kind: Middleware
# metadata:
#   name: puppetboard-auth
#   namespace: puppet
# spec:
#   basicAuth:
#     secret: puppetboard-auth-secret

---
#############################################
# HTTP to HTTPS Redirect (Optional)
#############################################
# Uncomment if you want to redirect HTTP to HTTPS
#
# apiVersion: traefik.io/v1alpha1
# kind: Middleware
# metadata:
#   name: https-redirect
#   namespace: puppet
# spec:
#   redirectScheme:
#     scheme: https
#     permanent: true
#
# ---
# apiVersion: traefik.io/v1alpha1
# kind: IngressRoute
# metadata:
#   name: puppetboard-http-redirect
#   namespace: puppet
# spec:
#   entryPoints:
#     - web
#   routes:
#     - match: Host(`puppetboard.yourdomain.internal`)
#       kind: Rule
#       services:
#         - name: puppet-puppetboard
#           port: 80
#       middlewares:
#         - name: https-redirect

---
#############################################
# IMPORTANT NOTES
#############################################
#
# 1. AGENT CONNECTION (Port 8140):
#    - MUST use SSL passthrough
#    - Agents verify Puppet's internal certificates
#    - TLS termination would break agent authentication
#    - Use IngressRouteTCP, not IngressRoute
#
# 2. WEB INTERFACES (Puppetboard, PuppetDB API):
#    - Can use normal HTTPS with TLS termination
#    - Use IngressRoute (not TCP)
#    - Certificates managed by cert-manager
#
# 3. DNS REQUIREMENTS:
#    - puppet.yourdomain.com â†’ must resolve to your Traefik LoadBalancer IP
#    - For internal domains (.internal), ensure internal DNS or /etc/hosts
#
# 4. TRAEFIK ENTRYPOINTS:
#    - Ensure 'websecure' entrypoint is defined in Traefik
#    - Typically: --entrypoints.websecure.address=:443
#
# 5. FIREWALL:
#    - Ensure port 8140 is accessible for agent connections
#    - Internal services can be restricted to VPN/internal network
